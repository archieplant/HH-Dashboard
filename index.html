<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPAYA - HH Generation Dashboard</title>

    <!-- CDN Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        /* ===========================================
           CSS VARIABLES - PPAYA BRAND COLOURS
           =========================================== */
        :root {
            --bg-primary: #1e293b;      /* Navy blue from platform */
            --bg-secondary: #0f172a;    /* Darker navy for sidebar/header */
            --bg-card: #ffffff;         /* White cards */
            --bg-main: #f8fafc;         /* Light background for main area */
            --accent: #3b82f6;          /* Brighter blue matching platform */
            --accent-hover: #2563eb;
            --text-primary: #1e293b;    /* Dark text on white */
            --text-primary-inverse: #ffffff; /* White text on dark */
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --border-dark: #334155;     /* Border for dark areas */
            --success: #14b8a6;
            --warning: #f59e0b;
            --error: #ef4444;
        }

        /* ===========================================
           RESET & BASE STYLES
           =========================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        /* ===========================================
           LAYOUT STRUCTURE
           =========================================== */

        /* Header - Fixed at top */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-dark);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            width: 120px;
            height: 40px;
            background: var(--accent);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .header-title h1 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .header-title h1 {
            color: var(--text-primary-inverse);
        }

        .header-title p {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .header-right {
            display: flex;
            gap: 1.5rem;
        }

        .header-stat {
            text-align: right;
        }

        .header-stat .label {
            color: var(--text-secondary);
            font-size: 0.75rem;
        }

        .header-stat .value {
            font-weight: 600;
            font-size: 1.125rem;
            color: var(--text-primary-inverse);
        }

        /* Main Container - Sidebar + Content */
        .container {
            display: flex;
            min-height: calc(100vh - 73px);
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-dark);
            padding: 1.5rem;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .sidebar-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-dark);
        }

        .sidebar-section:last-child {
            border-bottom: none;
        }

        .sidebar-section h3 {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary-inverse);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Main Content Area */
        .main {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            background: var(--bg-main);
        }

        /* ===========================================
           COMPONENTS
           =========================================== */

        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--border-dark);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .upload-area:hover {
            border-color: var(--accent);
            background: rgba(59, 130, 246, 0.1);
        }

        .upload-area input[type="file"] {
            display: none;
        }

        .upload-area .icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .upload-area .text {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* Site List Item */
        .site-item {
            background: var(--bg-primary);
            border: 1px solid var(--border-dark);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .site-item:hover {
            border-color: var(--accent);
        }

        .site-item.active {
            border-color: var(--accent);
            background: rgba(59, 130, 246, 0.2);
        }

        .site-item .info {
            flex: 1;
        }

        .site-item .name {
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-primary-inverse);
        }

        .site-item .meta {
            color: var(--text-secondary);
            font-size: 0.75rem;
        }

        .site-item .remove-btn {
            background: none;
            border: none;
            color: var(--error);
            cursor: pointer;
            padding: 0.25rem;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .site-item .remove-btn:hover {
            opacity: 1;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            transition: border-color 0.2s;
        }

        .stat-card:hover {
            border-color: var(--accent);
        }

        .stat-card .label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }

        .stat-card .value {
            font-size: 1.75rem;
            font-weight: 700;
        }

        .stat-card .subtitle {
            color: var(--text-secondary);
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        /* View Tabs */
        .view-tabs {
            display: flex;
            gap: 0.25rem;
            background: var(--bg-card);
            padding: 0.25rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            width: fit-content;
        }

        .view-tab {
            padding: 0.625rem 1.25rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .view-tab:hover {
            color: var(--text-primary);
            background: var(--bg-secondary);
        }

        .view-tab.active {
            background: var(--accent);
            color: var(--text-primary);
        }

        /* Chart Container */
        .chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .chart-container h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .chart-wrapper {
            height: 320px;
            position: relative;
        }

        /* Data Table */
        .data-table {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .data-table-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
        }

        .data-table-scroll {
            max-height: 400px;
            overflow-y: auto;
        }

        .data-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .data-table th {
            background: var(--bg-main);
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            color: var(--text-primary);
        }

        .data-table td {
            padding: 0.625rem 1rem;
            border-top: 1px solid var(--border);
            color: var(--text-primary);
        }

        .data-table tr:hover {
            background: rgba(59, 130, 246, 0.05);
        }

        /* Portfolio Table */
        .portfolio-table {
            width: 100%;
            border-collapse: collapse;
        }

        .portfolio-table th {
            text-align: left;
            padding: 1rem;
            background: var(--bg-main);
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .portfolio-table td {
            padding: 1rem;
            border-top: 1px solid var(--border);
            color: var(--text-primary);
        }

        .portfolio-table tr:hover {
            background: rgba(59, 130, 246, 0.05);
            cursor: pointer;
        }

        /* Buttons */
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .btn-primary {
            background: var(--accent);
            color: var(--text-primary);
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--accent);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.75rem;
            margin-bottom: 0.375rem;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            background: var(--bg-primary);
            border: 1px solid var(--border-dark);
            border-radius: 8px;
            padding: 0.625rem 0.875rem;
            color: var(--text-primary-inverse);
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Utilisation Bar */
        .utilisation-bar {
            width: 80px;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            display: inline-block;
            vertical-align: middle;
        }

        .utilisation-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 60vh;
            text-align: center;
        }

        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            color: var(--text-secondary);
            max-width: 400px;
            margin-bottom: 1.5rem;
        }

        /* Day Selector */
        .day-selector {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            font-size: 0.875rem;
            width: 100%;
            margin-bottom: 1rem;
            cursor: pointer;
        }

        .day-selector:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Date picker calendar icon styling */
        .day-selector::-webkit-calendar-picker-indicator {
            filter: invert(0);
            cursor: pointer;
            opacity: 0.7;
        }

        /* Date range selector */
        .date-range-selector {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .date-range-selector label {
            color: var(--text-primary);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .back-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Utility Classes */
        .hidden { display: none !important; }
        .text-success { color: var(--success); }
        .text-warning { color: var(--warning); }
        .text-error { color: var(--error); }
        .text-muted { color: var(--text-secondary); }
        .font-mono { font-family: 'SF Mono', Monaco, 'Courier New', monospace; }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Scrollbar for dark areas (sidebar) */
        .sidebar::-webkit-scrollbar-thumb {
            background: var(--border-dark);
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--border-dark);
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .header-right {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- ===========================================
         HEADER
         =========================================== -->
    <header class="header">
        <div class="header-left">
            <div class="logo">PPAYA</div>
            <div class="header-title">
                <h1>HH Generation Dashboard</h1>
                <p id="headerSubtitle">Upload generation data to begin</p>
            </div>
        </div>
        <div class="header-right" id="headerStats">
            <!-- Portfolio summary stats will be added here -->
        </div>
    </header>

    <!-- ===========================================
         MAIN CONTAINER
         =========================================== -->
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <!-- Upload Section -->
            <div class="sidebar-section">
                <h3>üìä Add Site</h3>
                <div class="upload-area" id="uploadArea">
                    <div class="icon">üìÅ</div>
                    <div class="text">Click or drag to upload HH data</div>
                    <input type="file" id="fileInput" accept=".xlsx,.xls" multiple>
                </div>
            </div>

            <!-- Sites List -->
            <div class="sidebar-section">
                <h3>‚ö° Loaded Sites (<span id="siteCount">0</span>)</h3>
                <div id="sitesList">
                    <p class="text-muted" style="font-size: 0.875rem;" id="noSitesMsg">No sites loaded yet</p>
                </div>
            </div>

            <!-- Site Configuration (shown when site selected) -->
            <div class="sidebar-section hidden" id="siteConfig">
                <h3>‚öôÔ∏è Site Configuration</h3>
                <div class="form-group">
                    <label>Site Name</label>
                    <input type="text" id="siteNameInput" placeholder="Enter site name">
                </div>
                <div class="form-group">
                    <label>Asset Type</label>
                    <select id="assetTypeSelect">
                        <option value="AD">üåø Anaerobic Digestion</option>
                        <option value="Wind">üí® Wind</option>
                        <option value="Solar">‚òÄÔ∏è Solar</option>
                        <option value="Hydro">üíß Hydro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Capacity (kW)</label>
                    <input type="number" id="capacityInput" placeholder="e.g. 200">
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main">
            <!-- Empty State -->
            <div class="empty-state" id="emptyState">
                <div class="icon">üìä</div>
                <h2>Upload HH Generation Data</h2>
                <p>Upload Excel files with half-hourly generation data. You can upload multiple sites and compare them.</p>
            </div>

            <!-- Dashboard Content (hidden until data loaded) -->
            <div class="hidden" id="dashboard">
                <!-- Portfolio View -->
                <div id="portfolioView">
                    <div class="chart-container">
                        <h3>Portfolio Overview</h3>
                        <div class="data-table-scroll">
                            <table class="portfolio-table">
                                <thead>
                                    <tr>
                                        <th>Site</th>
                                        <th>Type</th>
                                        <th>Capacity</th>
                                        <th>Total MWh</th>
                                        <th>CF %</th>
                                        <th>Availability</th>
                                        <th>Days</th>
                                    </tr>
                                </thead>
                                <tbody id="portfolioTableBody">
                                    <!-- Rows added dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Site Detail View (hidden until site selected) -->
                <div class="hidden" id="siteDetailView">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <button class="back-btn" id="backToPortfolio" style="margin-bottom: 0;">‚Üê Back to Portfolio</button>
                        <button class="btn btn-secondary" id="downloadReport">Download Report</button>
                    </div>

                    <!-- Stats Cards -->
                    <div class="stats-grid" id="statsGrid">
                        <!-- Cards added dynamically -->
                    </div>

                    <!-- View Tabs -->
                    <div class="view-tabs" id="viewTabs">
                        <button class="view-tab" data-view="hourly">Hourly</button>
                        <button class="view-tab" data-view="day">Day</button>
                        <button class="view-tab" data-view="week">Week</button>
                        <button class="view-tab active" data-view="month">Month</button>
                        <button class="view-tab" data-view="year">Year</button>
                    </div>

                    <!-- Date Range Controls (hidden for Year and Hourly) -->
                    <div id="dateRangeControls" class="chart-container" style="padding: 1rem;">
                        <div class="date-range-selector">
                            <label>From:</label>
                            <input type="date" class="day-selector" id="rangeStart" style="width: auto; margin-bottom: 0;">
                            <label>To:</label>
                            <input type="date" class="day-selector" id="rangeEnd" style="width: auto; margin-bottom: 0;">
                            <button class="btn btn-primary" id="applyRange">Apply Range</button>
                            <button class="btn btn-secondary" id="resetRange">Reset</button>
                        </div>
                    </div>

                    <!-- Hourly View -->
                    <div class="hidden" id="hourlyView">
                        <div class="chart-container">
                            <h3>Select Day</h3>
                            <input type="date" class="day-selector" id="daySelector">
                            <div class="stats-grid" id="hourlyStats" style="margin-top: 1rem;"></div>
                            <h3 id="hourlyChartTitle">Half-Hourly Profile</h3>
                            <div class="chart-wrapper">
                                <canvas id="hourlyChart"></canvas>
                            </div>
                        </div>
                        <div class="data-table">
                            <div class="data-table-header">Half-Hourly Data</div>
                            <div class="data-table-scroll">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Period</th>
                                            <th>Time</th>
                                            <th>Generation (kWh)</th>
                                            <th>Utilisation</th>
                                        </tr>
                                    </thead>
                                    <tbody id="hourlyTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Aggregate View (Day/Week/Month/Year) -->
                    <div id="aggregateView">
                        <div class="chart-container">
                            <h3 id="mainChartTitle">Monthly Generation</h3>
                            <div class="chart-wrapper">
                                <canvas id="mainChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-container">
                            <h3>Capacity Factor Trend</h3>
                            <div class="chart-wrapper">
                                <canvas id="cfChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ===========================================
         JAVASCRIPT
         =========================================== -->
    <script>
        /*
         * ===========================================
         * ASSET TYPE CONFIGURATIONS
         * ===========================================
         */
        const ASSET_TYPES = {
            AD: {
                name: 'Anaerobic Digestion',
                color: '#14b8a6',
                cfThresholds: { green: 70, orange: 60 }, // ‚â•70 green, 60-70 orange, <60 red
                icon: 'üåø'
            },
            Wind: {
                name: 'Wind',
                color: '#3b82f6',
                cfThresholds: { green: 30, orange: 20 }, // ‚â•30 green, 20-30 orange, <20 red
                icon: 'üí®'
            },
            Solar: {
                name: 'Solar',
                color: '#f59e0b',
                cfThresholds: { green: 10, orange: 5 }, // ‚â•10 green, 5-10 orange, <5 red
                icon: '‚òÄÔ∏è'
            },
            Hydro: {
                name: 'Hydro',
                color: '#06b6d4',
                cfThresholds: { green: 45, orange: 35 }, // ‚â•45 green, 35-45 orange, <35 red
                icon: 'üíß'
            }
        };

        /*
         * ===========================================
         * STATE MANAGEMENT
         * ===========================================
         */
        let sites = [];
        let selectedSiteId = null;
        let currentView = 'month';

        // Independent date ranges for each view
        let dateRanges = {
            day: { start: null, end: null },
            week: { start: null, end: null },
            month: { start: null, end: null }
        };

        // Chart instances
        let mainChart = null;
        let cfChart = null;
        let hourlyChart = null;

        /*
         * ===========================================
         * UTILITY FUNCTIONS
         * ===========================================
         */
        function getCFColor(cf, assetType) {
            const thresholds = ASSET_TYPES[assetType].cfThresholds;
            if (cf >= thresholds.green) return 'var(--success)';
            if (cf >= thresholds.orange) return 'var(--warning)';
            return 'var(--error)';
        }

        function getCFColorClass(cf, assetType) {
            const thresholds = ASSET_TYPES[assetType].cfThresholds;
            if (cf >= thresholds.green) return 'text-success';
            if (cf >= thresholds.orange) return 'text-warning';
            return 'text-error';
        }

        /*
         * ===========================================
         * EXCEL PARSING
         * ===========================================
         */
        function parseHHData(workbook, filename) {
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const rawData = XLSX.utils.sheet_to_json(sheet);

            const data = rawData.map(row => {
                let date;
                if (row.DATE instanceof Date) {
                    date = row.DATE;
                } else if (typeof row.DATE === 'number') {
                    date = new Date((row.DATE - 25569) * 86400 * 1000);
                } else if (typeof row.DATE === 'string') {
                    // Handle UK date format DD/MM/YYYY
                    const ukMatch = row.DATE.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
                    if (ukMatch) {
                        date = new Date(parseInt(ukMatch[3]), parseInt(ukMatch[2]) - 1, parseInt(ukMatch[1]));
                    } else {
                        date = new Date(row.DATE);
                    }
                } else {
                    date = new Date(row.DATE);
                }

                const hhValues = [];
                for (let i = 1; i <= 48; i++) {
                    hhValues.push(parseFloat(row[`P${i}_HHC`]) || 0);
                }

                const dailyTotal = hhValues.reduce((a, b) => a + b, 0);

                // Only create dateStr if date is valid
                const isValidDate = date instanceof Date && !isNaN(date.getTime());

                return {
                    date,
                    dateStr: isValidDate ? date.toISOString().split('T')[0] : null,
                    mpan: row.MPAN,
                    hhValues,
                    dailyKwh: dailyTotal,
                    dailyMwh: dailyTotal / 1000
                };
            }).filter(d => d.dateStr !== null)
              .sort((a, b) => a.date - b.date);

            return {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                filename,
                mpan: data[0]?.mpan || 'Unknown',
                name: filename.replace(/\.[^/.]+$/, ''),
                assetType: 'AD',
                capacityKw: null,
                data
            };
        }

        /*
         * ===========================================
         * CALCULATIONS
         * ===========================================
         */
        function calculateSiteStats(site) {
            if (!site.data || site.data.length === 0) return null;

            const cap = site.capacityKw || 0;
            const totalKwh = site.data.reduce((sum, d) => sum + d.dailyKwh, 0);
            const totalDays = site.data.length;
            const maxPossible = cap * totalDays * 24;
            const cf = cap > 0 ? (totalKwh / maxPossible) * 100 : 0;

            const sortedByOutput = [...site.data].sort((a, b) => b.dailyKwh - a.dailyKwh);
            const bestDay = sortedByOutput[0];
            const worstDay = sortedByOutput[sortedByOutput.length - 1];

            // Last 12 complete months (not partial months)
            // E.g., if latest data is May 15th, use May 1st prev year ‚Üí April 30th current year
            const lastDataDate = site.data[site.data.length - 1].date;
            const cutoffEnd = new Date(lastDataDate.getFullYear(), lastDataDate.getMonth(), 0); // End of previous month
            const cutoffStart = new Date(cutoffEnd.getFullYear(), cutoffEnd.getMonth() - 11, 1); // Start of month 12 months before
            const last12m = site.data.filter(d => d.date >= cutoffStart && d.date <= cutoffEnd);
            const l12mKwh = last12m.reduce((sum, d) => sum + d.dailyKwh, 0);
            const l12mCf = last12m.length > 0 && cap > 0 ? (l12mKwh / (cap * last12m.length * 24)) * 100 : 0;

            const outageDays = site.data.filter(d => d.dailyKwh < 100).length;

            return {
                totalMwh: totalKwh / 1000,
                totalDays,
                capacityFactor: cf,
                bestDay,
                worstDay,
                last12mMwh: l12mKwh / 1000,
                last12mCf: l12mCf,
                avgDailyKwh: totalKwh / totalDays,
                outageDays,
                availability: ((totalDays - outageDays) / totalDays) * 100,
                dateRange: {
                    start: site.data[0].date,
                    end: site.data[site.data.length - 1].date
                }
            };
        }

        function filterDataByRange(site, view) {
            if (!site || !site.data) return site.data;

            // Get date range for current view
            const range = dateRanges[view];

            // If no range set for this view, return appropriate default
            if (!range || !range.start || !range.end) {
                if (view === 'day') {
                    // Day view default: last 30 days
                    return site.data.slice(-30);
                }
                // Week/Month: return all data
                return site.data;
            }

            const startDate = new Date(range.start);
            const endDate = new Date(range.end);

            return site.data.filter(d => {
                const date = new Date(d.dateStr);
                return date >= startDate && date <= endDate;
            });
        }

        function getChartData(site, view) {
            if (!site || !site.data) return [];

            const cap = site.capacityKw || 0;

            // Apply view-specific date range filter FIRST
            const filteredData = filterDataByRange(site, view);

            if (view === 'day') {
                // filteredData already handles default (last 30) or custom range
                return filteredData.map(d => ({
                    label: d.date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' }),
                    generation: d.dailyKwh,
                    cf: cap > 0 ? (d.dailyKwh / (cap * 24)) * 100 : 0,
                    date: d.date,
                    dailyKwh: d.dailyKwh
                }));
            }

            if (view === 'week') {
                const weeks = {};
                filteredData.forEach(d => {
                    const weekStart = new Date(d.date);
                    weekStart.setDate(weekStart.getDate() - weekStart.getDay() + 1);
                    const key = weekStart.toISOString().split('T')[0];
                    if (!weeks[key]) weeks[key] = { days: [], total: 0, weekStart };
                    weeks[key].days.push(d);
                    weeks[key].total += d.dailyKwh;
                });

                return Object.values(weeks).map(w => ({
                    label: `w/c ${w.weekStart.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' })}`,
                    generation: w.total / 1000,
                    cf: cap > 0 ? (w.total / (cap * w.days.length * 24)) * 100 : 0,
                    totalKwh: w.total,
                    days: w.days
                }));
            }

            if (view === 'month') {
                const months = {};
                filteredData.forEach(d => {
                    const key = `${d.date.getFullYear()}-${String(d.date.getMonth() + 1).padStart(2, '0')}`;
                    if (!months[key]) months[key] = { days: [], total: 0, month: d.date };
                    months[key].days.push(d);
                    months[key].total += d.dailyKwh;
                });

                return Object.values(months).map(m => ({
                    label: m.month.toLocaleDateString('en-GB', { month: 'short', year: '2-digit' }),
                    generation: m.total / 1000,
                    cf: cap > 0 ? (m.total / (cap * m.days.length * 24)) * 100 : 0,
                    totalKwh: m.total,
                    days: m.days
                }));
            }

            if (view === 'year') {
                const years = {};
                filteredData.forEach(d => {
                    const key = d.date.getFullYear();
                    if (!years[key]) years[key] = { days: [], total: 0, year: key };
                    years[key].days.push(d);
                    years[key].total += d.dailyKwh;
                });

                return Object.values(years).map(y => ({
                    label: y.year.toString(),
                    generation: y.total / 1000,
                    cf: cap > 0 ? (y.total / (cap * y.days.length * 24)) * 100 : 0,
                    totalKwh: y.total,
                    days: y.days
                }));
            }

            return [];
        }

        function getHourlyData(site, dateStr) {
            if (!site || !site.data) return [];

            const dayData = site.data.find(d => d.dateStr === dateStr);
            if (!dayData) return [];

            const cap = site.capacityKw || 0;
            const maxHH = cap * 0.5;

            return dayData.hhValues.map((val, i) => {
                const hour = Math.floor(i / 2);
                const min = i % 2 === 0 ? '00' : '30';
                return {
                    period: i + 1,
                    time: `${hour.toString().padStart(2, '0')}:${min}`,
                    generation: val,
                    maxCapacity: maxHH,
                    utilisation: maxHH > 0 ? (val / maxHH) * 100 : 0
                };
            });
        }

        function calculatePeriodStats(chartData, view, site) {
            if (!chartData || chartData.length === 0) return null;

            const config = ASSET_TYPES[site.assetType];
            const hasCapacity = site.capacityKw && site.capacityKw > 0;

            let total = 0;
            let peak = 0;
            let min = Infinity;
            let cfValues = [];

            chartData.forEach(period => {
                const periodValue = view === 'day' ? period.generation : (period.totalKwh || period.generation * 1000);
                total += periodValue;

                if (periodValue > peak) peak = periodValue;
                if (periodValue < min && periodValue > 0) min = periodValue;

                if (period.cf) cfValues.push(period.cf);
            });

            if (min === Infinity) min = 0;

            const count = chartData.length;
            const avg = count > 0 ? total / count : 0;
            const avgCf = cfValues.length > 0
                ? cfValues.reduce((a, b) => a + b, 0) / cfValues.length
                : 0;

            // Unit conversion
            const unit = view === 'day' ? 'kWh' : 'MWh';
            const displayTotal = view === 'day' ? total : total / 1000;
            const displayPeak = view === 'day' ? peak : peak / 1000;
            const displayMin = view === 'day' ? min : min / 1000;
            const displayAvg = view === 'day' ? avg : avg / 1000;

            return {
                total: displayTotal,
                peak: displayPeak,
                min: displayMin,
                avg: displayAvg,
                cf: avgCf,
                unit: unit,
                count: count,
                hasCapacity: hasCapacity,
                cfColor: hasCapacity ? getCFColor(avgCf, site.assetType) : 'var(--text-primary)'
            };
        }

        /*
         * ===========================================
         * UI UPDATES
         * ===========================================
         */
        function updateUI() {
            document.getElementById('siteCount').textContent = sites.length;
            document.getElementById('headerSubtitle').textContent =
                sites.length > 0
                    ? `${sites.length} site${sites.length > 1 ? 's' : ''} loaded`
                    : 'Upload generation data to begin';

            // Update header stats
            if (sites.length > 0) {
                const totalMwh = sites.reduce((sum, site) => {
                    const stats = calculateSiteStats(site);
                    return sum + (stats ? stats.totalMwh : 0);
                }, 0);

                const totalCapacity = sites.reduce((sum, site) => sum + (site.capacityKw || 0), 0);

                document.getElementById('headerStats').innerHTML = `
                    <div class="header-stat">
                        <div class="label">Total Capacity</div>
                        <div class="value">${formatNumber(totalCapacity, 0)} kW</div>
                    </div>
                    <div class="header-stat">
                        <div class="label">Total Generation</div>
                        <div class="value">${formatNumber(totalMwh, 1)} MWh</div>
                    </div>
                `;
            } else {
                document.getElementById('headerStats').innerHTML = '';
            }

            document.getElementById('emptyState').classList.toggle('hidden', sites.length > 0);
            document.getElementById('dashboard').classList.toggle('hidden', sites.length === 0);

            updateSitesList();
            updatePortfolioTable();

            if (selectedSiteId) {
                updateSiteDetailView();
            }
        }

        function updateSitesList() {
            const container = document.getElementById('sitesList');
            let noSitesMsg = document.getElementById('noSitesMsg');

            // Remove all site items but preserve noSitesMsg
            const childrenToRemove = Array.from(container.children).filter(
                child => child.id !== 'noSitesMsg'
            );
            childrenToRemove.forEach(child => container.removeChild(child));

            if (sites.length === 0) {
                // If noSitesMsg was removed, recreate it
                if (!noSitesMsg) {
                    noSitesMsg = document.createElement('p');
                    noSitesMsg.id = 'noSitesMsg';
                    noSitesMsg.className = 'text-muted';
                    noSitesMsg.style.fontSize = '0.875rem';
                    noSitesMsg.textContent = 'No sites loaded yet';
                    container.appendChild(noSitesMsg);
                }
                noSitesMsg.classList.remove('hidden');
                return;
            }

            if (noSitesMsg) {
                noSitesMsg.classList.add('hidden');
            }

            sites.forEach(site => {
                const stats = calculateSiteStats(site);
                const config = ASSET_TYPES[site.assetType];

                const siteItem = document.createElement('div');
                siteItem.className = `site-item ${site.id === selectedSiteId ? 'active' : ''}`;
                siteItem.dataset.siteId = site.id;

                siteItem.innerHTML = `
                    <div class="info">
                        <div class="name">${config.icon} ${site.name}</div>
                        <div class="meta">${stats ? formatNumber(stats.totalMwh, 1) + ' MWh ‚Ä¢ ' + site.data.length + ' days' : 'Configure capacity'}</div>
                    </div>
                    <button class="remove-btn">‚úï</button>
                `;

                // Add click handler for site selection
                siteItem.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('remove-btn')) {
                        selectSite(site.id);
                    }
                });

                // Add click handler for remove button
                const removeBtn = siteItem.querySelector('.remove-btn');
                removeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    removeSite(site.id);
                });

                container.appendChild(siteItem);
            });
        }

        function updatePortfolioTable() {
            const tbody = document.getElementById('portfolioTableBody');
            tbody.innerHTML = '';

            sites.forEach(site => {
                const stats = calculateSiteStats(site);
                const config = ASSET_TYPES[site.assetType];
                const hasCapacity = site.capacityKw && site.capacityKw > 0;
                const cfColor = stats && hasCapacity
                    ? getCFColorClass(stats.capacityFactor, site.assetType)
                    : '';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${config.icon} ${site.name}</strong></td>
                    <td>${config.name}</td>
                    <td>${hasCapacity ? site.capacityKw + ' kW' : '-'}</td>
                    <td>${stats ? formatNumber(stats.totalMwh, 1) : '-'}</td>
                    <td class="${cfColor}">${stats && hasCapacity ? formatNumber(stats.capacityFactor, 1) + '%' : '-'}</td>
                    <td>${stats ? formatNumber(stats.availability, 1) + '%' : '-'}</td>
                    <td>${site.data.length}</td>
                `;

                row.addEventListener('click', () => selectSite(site.id));
                tbody.appendChild(row);
            });
        }

        function selectSite(siteId) {
            selectedSiteId = siteId;

            document.querySelectorAll('.site-item').forEach(item => {
                item.classList.toggle('active', item.dataset.siteId === siteId);
            });

            document.getElementById('siteConfig').classList.remove('hidden');
            document.getElementById('portfolioView').classList.add('hidden');
            document.getElementById('siteDetailView').classList.remove('hidden');

            const site = sites.find(s => s.id === siteId);
            if (site) {
                document.getElementById('siteNameInput').value = site.name;
                document.getElementById('assetTypeSelect').value = site.assetType;
                document.getElementById('capacityInput').value = site.capacityKw || '';

                populateDaySelector(site);
                initializeDateRangePickers(site);
            }

            updateSiteDetailView();
        }

        function populateDaySelector(site) {
            if (!site || !site.data || site.data.length === 0) return;

            const selector = document.getElementById('daySelector');
            const firstDate = site.data[0].dateStr;
            const lastDate = site.data[site.data.length - 1].dateStr;

            // Set min and max dates based on available data
            selector.min = firstDate;
            selector.max = lastDate;

            // Set default to most recent date
            selector.value = lastDate;
        }

        function updateSiteDetailView() {
            const site = sites.find(s => s.id === selectedSiteId);
            if (!site) return;

            const stats = calculateSiteStats(site);
            const config = ASSET_TYPES[site.assetType];
            const hasCapacity = site.capacityKw && site.capacityKw > 0;

            const cfColor = hasCapacity ? getCFColor(stats.capacityFactor, site.assetType) : 'var(--text-primary)';
            const availColor = stats.availability >= 95 ? 'var(--success)' : 'var(--warning)';

            const thresholds = config.cfThresholds;
            const targetText = `‚â•${thresholds.green}% target`;

            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card">
                    <div class="label">Total Generation</div>
                    <div class="value">${formatNumber(stats.totalMwh, 1)} MWh</div>
                    <div class="subtitle">${stats.totalDays} days</div>
                </div>
                <div class="stat-card">
                    <div class="label">Capacity Factor</div>
                    <div class="value" style="color: ${cfColor}">${hasCapacity ? formatNumber(stats.capacityFactor, 1) + '%' : 'Set capacity'}</div>
                    <div class="subtitle">${targetText}</div>
                </div>
                <div class="stat-card">
                    <div class="label">Last 12 Months</div>
                    <div class="value">${formatNumber(stats.last12mMwh, 1)} MWh</div>
                    <div class="subtitle">CF: ${hasCapacity ? formatNumber(stats.last12mCf, 1) + '%' : '-'}</div>
                </div>
                <div class="stat-card">
                    <div class="label">Daily Average</div>
                    <div class="value">${formatNumber(stats.avgDailyKwh, 0)} kWh</div>
                    <div class="subtitle">Best: ${formatNumber(stats.bestDay.dailyKwh, 0)} kWh</div>
                </div>
                <div class="stat-card">
                    <div class="label">Availability</div>
                    <div class="value" style="color: ${availColor}">${formatNumber(stats.availability, 1)}%</div>
                    <div class="subtitle">${stats.outageDays} outage days</div>
                </div>
            `;

            updateCharts();
        }

        function removeSite(siteId) {
            sites = sites.filter(s => s.id !== siteId);
            if (selectedSiteId === siteId) {
                selectedSiteId = null;
                document.getElementById('siteConfig').classList.add('hidden');
                document.getElementById('siteDetailView').classList.add('hidden');
                document.getElementById('portfolioView').classList.remove('hidden');
            }
            updateUI();
        }

        function backToPortfolio() {
            selectedSiteId = null;
            document.querySelectorAll('.site-item').forEach(item => {
                item.classList.remove('active');
            });
            document.getElementById('siteConfig').classList.add('hidden');
            document.getElementById('siteDetailView').classList.add('hidden');
            document.getElementById('portfolioView').classList.remove('hidden');
        }

        /*
         * ===========================================
         * CHART RENDERING
         * ===========================================
         */
        function updateCharts() {
            const site = sites.find(s => s.id === selectedSiteId);
            if (!site) return;

            const config = ASSET_TYPES[site.assetType];

            if (currentView === 'hourly') {
                document.getElementById('hourlyView').classList.remove('hidden');
                document.getElementById('aggregateView').classList.add('hidden');
                updateHourlyView();
            } else {
                document.getElementById('hourlyView').classList.add('hidden');
                document.getElementById('aggregateView').classList.remove('hidden');

                const chartData = getChartData(site, currentView);
                const labels = chartData.map(d => d.label);
                const genData = chartData.map(d => d.generation);
                const cfData = chartData.map(d => d.cf);

                // Calculate and display period stats
                const periodStats = calculatePeriodStats(chartData, currentView, site);

                if (periodStats) {
                    // Create/update stats grid above chart
                    let statsContainer = document.getElementById('periodStatsGrid');
                    if (!statsContainer) {
                        // Create container if doesn't exist
                        const mainChartContainer = document.getElementById('mainChart').closest('.chart-container');
                        statsContainer = document.createElement('div');
                        statsContainer.id = 'periodStatsGrid';
                        statsContainer.className = 'stats-grid';
                        statsContainer.style.marginBottom = '1rem';
                        mainChartContainer.insertBefore(statsContainer, mainChartContainer.firstChild);
                    }

                    statsContainer.innerHTML = `
                        <div class="stat-card" style="padding: 0.75rem;">
                            <div class="label">Period Total</div>
                            <div class="value" style="font-size: 1.25rem;">${formatNumber(periodStats.total, 1)} ${periodStats.unit}</div>
                            <div class="subtitle">${periodStats.count} ${currentView === 'day' ? 'days' : currentView + 's'}</div>
                        </div>
                        <div class="stat-card" style="padding: 0.75rem;">
                            <div class="label">Avg Capacity Factor</div>
                            <div class="value" style="font-size: 1.25rem; color: ${periodStats.cfColor}">
                                ${periodStats.hasCapacity ? formatNumber(periodStats.cf, 1) + '%' : '-'}
                            </div>
                            <div class="subtitle">Across period</div>
                        </div>
                        <div class="stat-card" style="padding: 0.75rem;">
                            <div class="label">Peak ${currentView === 'day' ? 'Day' : currentView}</div>
                            <div class="value" style="font-size: 1.25rem; color: var(--success);">
                                ${formatNumber(periodStats.peak, 1)} ${periodStats.unit}
                            </div>
                        </div>
                        <div class="stat-card" style="padding: 0.75rem;">
                            <div class="label">Min ${currentView === 'day' ? 'Day' : currentView}</div>
                            <div class="value" style="font-size: 1.25rem; color: var(--error);">
                                ${formatNumber(periodStats.min, 1)} ${periodStats.unit}
                            </div>
                        </div>
                        <div class="stat-card" style="padding: 0.75rem;">
                            <div class="label">Average ${currentView === 'day' ? 'Day' : currentView}</div>
                            <div class="value" style="font-size: 1.25rem;">
                                ${formatNumber(periodStats.avg, 1)} ${periodStats.unit}
                            </div>
                        </div>
                    `;
                }

                // Update title
                const titles = {
                    day: 'Daily Generation (Last 30 Days) ‚Äî kWh',
                    week: 'Weekly Generation ‚Äî MWh',
                    month: 'Monthly Generation ‚Äî MWh',
                    year: 'Yearly Generation ‚Äî MWh'
                };

                // Update title to reflect date range if active
                let title = titles[currentView];
                const range = dateRanges[currentView];
                if (range && range.start && range.end && currentView !== 'year') {
                    const startDate = new Date(range.start).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
                    const endDate = new Date(range.end).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
                    title = `${currentView === 'day' ? 'Daily' : currentView === 'week' ? 'Weekly' : 'Monthly'} Generation (${startDate} - ${endDate})`;
                }

                document.getElementById('mainChartTitle').textContent = title;

                if (mainChart) mainChart.destroy();
                mainChart = new Chart(document.getElementById('mainChart'), {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [{
                            label: currentView === 'day' ? 'Generation (kWh)' : 'Generation (MWh)',
                            data: genData,
                            backgroundColor: config.color,
                            borderRadius: 4,
                            yAxisID: 'y'
                        }, {
                            label: 'Capacity Factor (%)',
                            data: cfData,
                            type: 'line',
                            borderColor: '#f59e0b',
                            backgroundColor: 'transparent',
                            tension: 0.3,
                            pointRadius: 3,
                            pointBackgroundColor: '#f59e0b',
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { labels: { color: '#64748b' } }
                        },
                        scales: {
                            x: { ticks: { color: '#64748b' }, grid: { color: '#e2e8f0' } },
                            y: {
                                ticks: { color: '#64748b' },
                                grid: { color: '#e2e8f0' },
                                title: { display: true, text: currentView === 'day' ? 'kWh' : 'MWh', color: '#64748b' }
                            },
                            y1: {
                                position: 'right',
                                ticks: { color: '#f59e0b' },
                                grid: { display: false },
                                min: 0,
                                max: 100,
                                title: { display: true, text: 'CF %', color: '#f59e0b' }
                            }
                        }
                    }
                });

                if (cfChart) cfChart.destroy();
                cfChart = new Chart(document.getElementById('cfChart'), {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Capacity Factor (%)',
                            data: cfData,
                            borderColor: config.color,
                            backgroundColor: config.color + '40',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { color: '#64748b' } }
                        },
                        scales: {
                            x: { ticks: { color: '#64748b' }, grid: { color: '#e2e8f0' } },
                            y: {
                                ticks: { color: '#64748b' },
                                grid: { color: '#e2e8f0' },
                                min: 0,
                                max: 100
                            }
                        }
                    }
                });
            }
        }

        function updateHourlyView() {
            const site = sites.find(s => s.id === selectedSiteId);
            if (!site) return;

            const selectedDate = document.getElementById('daySelector').value;
            if (!selectedDate) return;

            const config = ASSET_TYPES[site.assetType];
            const hourlyData = getHourlyData(site, selectedDate);

            // If no data for selected date, show message
            if (hourlyData.length === 0) {
                document.getElementById('hourlyStats').innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 2rem; color: var(--text-secondary);">
                        No data available for ${selectedDate}. Please select a date within the available range.
                    </div>
                `;
                return;
            }

            const genValues = hourlyData.map(h => h.generation);
            const total = genValues.reduce((a, b) => a + b, 0);
            const max = Math.max(...genValues);
            const min = Math.min(...genValues.filter(v => v > 0)) || 0;
            const avg = total / 48;
            const hasCapacity = site.capacityKw && site.capacityKw > 0;
            const cf = hasCapacity ? (total / (site.capacityKw * 24)) * 100 : 0;

            const cfColor = hasCapacity ? getCFColor(cf, site.assetType) : 'var(--text-primary)';

            document.getElementById('hourlyStats').innerHTML = `
                <div class="stat-card" style="padding: 0.75rem;">
                    <div class="label">Day Total</div>
                    <div class="value" style="font-size: 1.25rem;">${formatNumber(total, 0)} kWh</div>
                </div>
                <div class="stat-card" style="padding: 0.75rem;">
                    <div class="label">Capacity Factor</div>
                    <div class="value" style="font-size: 1.25rem; color: ${hasCapacity ? cfColor : 'var(--text-primary)'}">${hasCapacity ? formatNumber(cf, 1) + '%' : '-'}</div>
                </div>
                <div class="stat-card" style="padding: 0.75rem;">
                    <div class="label">Peak HH</div>
                    <div class="value" style="font-size: 1.25rem; color: var(--success);">${formatNumber(max, 1)} kWh</div>
                </div>
                <div class="stat-card" style="padding: 0.75rem;">
                    <div class="label">Min HH</div>
                    <div class="value" style="font-size: 1.25rem; color: var(--error);">${formatNumber(min, 1)} kWh</div>
                </div>
                <div class="stat-card" style="padding: 0.75rem;">
                    <div class="label">Average HH</div>
                    <div class="value" style="font-size: 1.25rem;">${formatNumber(avg, 1)} kWh</div>
                </div>
            `;

            const dayData = site.data.find(d => d.dateStr === selectedDate);
            document.getElementById('hourlyChartTitle').textContent = `Half-Hourly Profile ‚Äî ${dayData.date.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}`;

            const labels = hourlyData.map(h => h.time);
            const genDataPoints = hourlyData.map(h => h.generation);
            const maxCapData = hourlyData.map(h => h.maxCapacity);

            if (hourlyChart) hourlyChart.destroy();
            hourlyChart = new Chart(document.getElementById('hourlyChart'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Max Capacity (kWh)',
                            data: maxCapData,
                            backgroundColor: '#e2e8f0',
                            borderRadius: 4,
                            order: 2
                        },
                        {
                            label: 'Generation (kWh)',
                            data: genDataPoints,
                            backgroundColor: config.color,
                            borderRadius: 4,
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#64748b' } }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#64748b', maxRotation: 45, minRotation: 45 },
                            grid: { color: '#e2e8f0' }
                        },
                        y: {
                            ticks: { color: '#64748b' },
                            grid: { color: '#e2e8f0' }
                        }
                    }
                }
            });

            const tableBody = document.getElementById('hourlyTableBody');
            tableBody.innerHTML = hourlyData.map(h => `
                <tr>
                    <td style="color: #94a3b8;">${h.period}</td>
                    <td style="font-family: monospace;">${h.time}</td>
                    <td style="color: ${config.color}; font-family: monospace;">${formatNumber(h.generation, 1)}</td>
                    <td>
                        <div class="utilisation-bar">
                            <div class="utilisation-fill" style="width: ${Math.min(h.utilisation, 100)}%; background: ${config.color};"></div>
                        </div>
                        <span style="color: #94a3b8; font-size: 0.75rem;">${formatNumber(h.utilisation, 0)}%</span>
                    </td>
                </tr>
            `).join('');
        }

        /*
         * ===========================================
         * UTILITY FUNCTIONS
         * ===========================================
         */
        function formatNumber(num, decimals = 0) {
            if (num === null || num === undefined || isNaN(num)) return '-';
            return num.toLocaleString(undefined, {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        }

        /*
         * ===========================================
         * EXPORT FUNCTIONS
         * ===========================================
         */
        function downloadReport() {
            const site = sites.find(s => s.id === selectedSiteId);
            if (!site) return;

            const wb = XLSX.utils.book_new();

            // Sheet 1: Summary + Outages
            const summaryData = buildSummarySheet(site);
            const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws1, 'Summary');

            // Sheet 2: Current View Data
            const viewData = buildViewDataSheet(site, currentView);
            const ws2 = XLSX.utils.aoa_to_sheet(viewData);
            XLSX.utils.book_append_sheet(wb, ws2, getViewSheetName(currentView));

            // Download
            const filename = `${site.name.replace(/[^a-z0-9]/gi, '_')}_Report_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
        }

        function buildSummarySheet(site) {
            const stats = calculateSiteStats(site);
            const outages = site.data.filter(d => d.dailyKwh === 0);

            const rows = [
                ['Site Summary'],
                [''],
                ['Site Name', site.name],
                ['MPAN', site.mpan],
                ['Asset Type', ASSET_TYPES[site.assetType].name],
                ['Capacity (kW)', site.capacityKw || 'Not set'],
                ['Data Range', `${stats.dateRange.start} to ${stats.dateRange.end}`],
                ['Total Days', stats.totalDays],
                [''],
                ['Performance'],
                ['Total Generation (MWh)', parseFloat(stats.totalMwh.toFixed(1))],
                ['Overall Capacity Factor', stats.capacityFactor.toFixed(1) + '%'],
                ['Last 12 Months (MWh)', parseFloat(stats.last12mMwh.toFixed(1))],
                ['Last 12 Months CF', stats.last12mCf.toFixed(1) + '%'],
                ['Availability', stats.availability.toFixed(1) + '%'],
                [''],
                ['Best Day', stats.bestDay.date.toLocaleDateString('en-GB'), parseFloat(stats.bestDay.dailyKwh.toFixed(0)) + ' kWh'],
                ['Worst Day', stats.worstDay.date.toLocaleDateString('en-GB'), parseFloat(stats.worstDay.dailyKwh.toFixed(0)) + ' kWh'],
                [''],
                [''],
                ['Outages (0 Generation Days)', `${outages.length} days`],
                ['Date', 'Generation (kWh)']
            ];

            // Add outage rows
            outages.forEach(d => {
                rows.push([d.date.toLocaleDateString('en-GB'), 0]);
            });

            return rows;
        }

        function buildViewDataSheet(site, view) {
            const chartData = getChartData(site, view);
            const periodStats = calculatePeriodStats(chartData, view, site);

            // Header with stats
            const rows = [
                [`${view.charAt(0).toUpperCase() + view.slice(1)} View Data`],
                ['']
            ];

            if (periodStats) {
                rows.push(['Period Total', parseFloat(periodStats.total.toFixed(1)) + ' ' + periodStats.unit]);
                rows.push(['Average CF', periodStats.cf.toFixed(1) + '%']);
                rows.push(['Peak', parseFloat(periodStats.peak.toFixed(1)) + ' ' + periodStats.unit]);
                rows.push(['Min', parseFloat(periodStats.min.toFixed(1)) + ' ' + periodStats.unit]);
                rows.push(['Average', parseFloat(periodStats.avg.toFixed(1)) + ' ' + periodStats.unit]);
                rows.push(['']);
            }

            // Column headers and data based on view
            if (view === 'hourly') {
                const selectedDay = document.getElementById('daySelector').value;
                const hourlyData = getHourlyData(site, selectedDay);
                rows.push(['Period', 'Time', 'Generation (kWh)', 'Utilisation (%)']);
                hourlyData.forEach(d => {
                    rows.push([d.period, d.time, parseFloat(d.generation.toFixed(2)), parseFloat(d.utilisation.toFixed(1))]);
                });
            } else if (view === 'day') {
                rows.push(['Date', 'Generation (kWh)', 'Capacity Factor (%)']);
                chartData.forEach(d => {
                    rows.push([d.date.toLocaleDateString('en-GB'), parseFloat(d.generation.toFixed(1)), parseFloat(d.cf.toFixed(1))]);
                });
            } else if (view === 'week') {
                rows.push(['Week Starting', 'Generation (MWh)', 'Capacity Factor (%)']);
                chartData.forEach(d => {
                    rows.push([d.label, parseFloat(d.generation.toFixed(2)), parseFloat(d.cf.toFixed(1))]);
                });
            } else if (view === 'month') {
                rows.push(['Month', 'Generation (MWh)', 'Capacity Factor (%)']);
                chartData.forEach(d => {
                    rows.push([d.label, parseFloat(d.generation.toFixed(2)), parseFloat(d.cf.toFixed(1))]);
                });
            } else if (view === 'year') {
                rows.push(['Year', 'Generation (MWh)', 'Capacity Factor (%)']);
                chartData.forEach(d => {
                    rows.push([d.label, parseFloat(d.generation.toFixed(2)), parseFloat(d.cf.toFixed(1))]);
                });
            }

            return rows;
        }

        function getViewSheetName(view) {
            const names = {
                hourly: 'Hourly Data',
                day: 'Daily Data',
                week: 'Weekly Data',
                month: 'Monthly Data',
                year: 'Yearly Data'
            };
            return names[view] || 'Data';
        }

        /*
         * ===========================================
         * EVENT LISTENERS
         * ===========================================
         */

        document.getElementById('uploadArea').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const workbook = XLSX.read(evt.target.result, { type: 'binary', cellDates: true });
                        const site = parseHHData(workbook, file.name);
                        sites.push(site);
                        updateUI();
                    } catch (err) {
                        alert('Error parsing file: ' + err.message);
                    }
                };
                reader.readAsBinaryString(file);
            });
            e.target.value = '';
        });

        document.getElementById('siteNameInput').addEventListener('input', (e) => {
            const site = sites.find(s => s.id === selectedSiteId);
            if (site) {
                site.name = e.target.value;
                updateUI();
            }
        });

        document.getElementById('assetTypeSelect').addEventListener('change', (e) => {
            const site = sites.find(s => s.id === selectedSiteId);
            if (site) {
                site.assetType = e.target.value;
                if (selectedSiteId) {
                    updateSiteDetailView();
                }
                updateUI();
            }
        });

        document.getElementById('capacityInput').addEventListener('input', (e) => {
            const site = sites.find(s => s.id === selectedSiteId);
            if (site) {
                const value = parseFloat(e.target.value);
                site.capacityKw = isNaN(value) || value <= 0 ? null : value;
                if (selectedSiteId) {
                    updateSiteDetailView();
                }
                updateUI();
            }
        });

        document.getElementById('viewTabs').addEventListener('click', (e) => {
            if (e.target.classList.contains('view-tab')) {
                document.querySelectorAll('.view-tab').forEach(t => t.classList.remove('active'));
                e.target.classList.add('active');
                currentView = e.target.dataset.view;

                document.getElementById('hourlyView').classList.toggle('hidden', currentView !== 'hourly');
                document.getElementById('aggregateView').classList.toggle('hidden', currentView === 'hourly');

                // Show/hide date range controls (hide for Year and Hourly)
                const showRangeControls = ['day', 'week', 'month'].includes(currentView);
                document.getElementById('dateRangeControls').classList.toggle('hidden', !showRangeControls);

                // Reload date pickers with view-specific values
                if (showRangeControls && selectedSiteId) {
                    const site = sites.find(s => s.id === selectedSiteId);
                    initializeDateRangePickers(site);
                }

                updateCharts();
            }
        });

        // Initialize date range pickers with view-specific values
        function initializeDateRangePickers(site) {
            if (!site || !site.data || site.data.length === 0) return;

            const rangeStart = document.getElementById('rangeStart');
            const rangeEnd = document.getElementById('rangeEnd');

            const firstDate = site.data[0].dateStr;
            const lastDate = site.data[site.data.length - 1].dateStr;

            // Set min/max constraints
            rangeStart.min = firstDate;
            rangeStart.max = lastDate;
            rangeEnd.min = firstDate;
            rangeEnd.max = lastDate;

            // Load saved range for current view, or set defaults
            const range = dateRanges[currentView];
            if (range && range.start && range.end) {
                rangeStart.value = range.start;
                rangeEnd.value = range.end;
            } else {
                // Default for day view: last 30 days
                if (currentView === 'day') {
                    const lastDateObj = new Date(lastDate);
                    const thirtyDaysAgo = new Date(lastDateObj);
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    rangeStart.value = thirtyDaysAgo.toISOString().split('T')[0];
                    rangeEnd.value = lastDate;
                } else {
                    // Week/Month: all data
                    rangeStart.value = firstDate;
                    rangeEnd.value = lastDate;
                }
            }
        }

        // Apply date range button - saves to current view
        document.getElementById('applyRange').addEventListener('click', () => {
            const startValue = document.getElementById('rangeStart').value;
            const endValue = document.getElementById('rangeEnd').value;

            if (startValue && endValue) {
                const start = new Date(startValue);
                const end = new Date(endValue);

                if (start > end) {
                    alert('Start date must be before end date');
                    return;
                }

                // Save range for current view
                dateRanges[currentView] = {
                    start: startValue,
                    end: endValue
                };

                updateCharts();
            }
        });

        // Reset date range button - clears current view's range
        document.getElementById('resetRange').addEventListener('click', () => {
            // Clear range for current view
            dateRanges[currentView] = { start: null, end: null };

            const site = sites.find(s => s.id === selectedSiteId);
            initializeDateRangePickers(site);
            updateCharts();
        });

        document.getElementById('daySelector').addEventListener('change', updateHourlyView);

        document.getElementById('backToPortfolio').addEventListener('click', backToPortfolio);

        document.getElementById('downloadReport').addEventListener('click', downloadReport);

        // Drag and drop
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = 'var(--accent)';
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = 'var(--border)';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = 'var(--border)';

            const files = Array.from(e.dataTransfer.files);
            files.forEach(file => {
                if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        try {
                            const workbook = XLSX.read(evt.target.result, { type: 'binary', cellDates: true });
                            const site = parseHHData(workbook, file.name);
                            sites.push(site);
                            updateUI();
                        } catch (err) {
                            alert('Error parsing file: ' + err.message);
                        }
                    };
                    reader.readAsBinaryString(file);
                }
            });
        });

        // Initial render
        updateUI();
    </script>
</body>
</html>
