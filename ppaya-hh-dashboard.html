<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPAYA - HH Generation Dashboard</title>

    <!-- CDN Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        /* ===========================================
           CSS VARIABLES - PPAYA BRAND COLOURS
           =========================================== */
        :root {
            --bg-primary: #0a1628;
            --bg-secondary: #0f1f35;
            --bg-card: #162236;
            --accent: #14b8a6;
            --accent-hover: #0d9488;
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --border: #1e3a5f;
            --success: #14b8a6;
            --warning: #f59e0b;
            --error: #ef4444;
        }

        /* ===========================================
           RESET & BASE STYLES
           =========================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        /* ===========================================
           LAYOUT STRUCTURE
           =========================================== */

        /* Header - Fixed at top */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            width: 120px;
            height: 40px;
            background: var(--accent);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .header-title h1 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .header-title p {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .header-right {
            display: flex;
            gap: 1.5rem;
        }

        .header-stat {
            text-align: right;
        }

        .header-stat .label {
            color: var(--text-secondary);
            font-size: 0.75rem;
        }

        .header-stat .value {
            font-weight: 600;
            font-size: 1.125rem;
            color: var(--accent);
        }

        /* Main Container - Sidebar + Content */
        .container {
            display: flex;
            min-height: calc(100vh - 73px);
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            padding: 1.5rem;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .sidebar-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-section:last-child {
            border-bottom: none;
        }

        .sidebar-section h3 {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Main Content Area */
        .main {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }

        /* ===========================================
           COMPONENTS
           =========================================== */

        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .upload-area:hover {
            border-color: var(--accent);
            background: rgba(20, 184, 166, 0.05);
        }

        .upload-area input[type="file"] {
            display: none;
        }

        .upload-area .icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .upload-area .text {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* Site List Item */
        .site-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .site-item:hover {
            border-color: var(--accent);
        }

        .site-item.active {
            border-color: var(--accent);
            background: rgba(20, 184, 166, 0.1);
        }

        .site-item .info {
            flex: 1;
        }

        .site-item .name {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .site-item .meta {
            color: var(--text-secondary);
            font-size: 0.75rem;
        }

        .site-item .remove-btn {
            background: none;
            border: none;
            color: var(--error);
            cursor: pointer;
            padding: 0.25rem;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .site-item .remove-btn:hover {
            opacity: 1;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            transition: border-color 0.2s;
        }

        .stat-card:hover {
            border-color: var(--accent);
        }

        .stat-card .label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }

        .stat-card .value {
            font-size: 1.75rem;
            font-weight: 700;
        }

        .stat-card .subtitle {
            color: var(--text-secondary);
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        /* View Tabs */
        .view-tabs {
            display: flex;
            gap: 0.25rem;
            background: var(--bg-card);
            padding: 0.25rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            width: fit-content;
        }

        .view-tab {
            padding: 0.625rem 1.25rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .view-tab:hover {
            color: var(--text-primary);
            background: var(--bg-secondary);
        }

        .view-tab.active {
            background: var(--accent);
            color: var(--text-primary);
        }

        /* Chart Container */
        .chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .chart-container h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .chart-wrapper {
            height: 320px;
            position: relative;
        }

        /* Data Table */
        .data-table {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .data-table-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
        }

        .data-table-scroll {
            max-height: 400px;
            overflow-y: auto;
        }

        .data-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .data-table th {
            background: var(--bg-secondary);
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .data-table td {
            padding: 0.625rem 1rem;
            border-top: 1px solid var(--border);
        }

        .data-table tr:hover {
            background: rgba(20, 184, 166, 0.05);
        }

        /* Portfolio Table */
        .portfolio-table {
            width: 100%;
            border-collapse: collapse;
        }

        .portfolio-table th {
            text-align: left;
            padding: 1rem;
            background: var(--bg-secondary);
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .portfolio-table td {
            padding: 1rem;
            border-top: 1px solid var(--border);
        }

        .portfolio-table tr:hover {
            background: rgba(20, 184, 166, 0.05);
            cursor: pointer;
        }

        /* Buttons */
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .btn-primary {
            background: var(--accent);
            color: var(--text-primary);
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--accent);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.75rem;
            margin-bottom: 0.375rem;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.625rem 0.875rem;
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Utilisation Bar */
        .utilisation-bar {
            width: 80px;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            display: inline-block;
            vertical-align: middle;
        }

        .utilisation-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 60vh;
            text-align: center;
        }

        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            color: var(--text-secondary);
            max-width: 400px;
            margin-bottom: 1.5rem;
        }

        /* Day Selector */
        .day-selector {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            font-size: 0.875rem;
            width: 100%;
            margin-bottom: 1rem;
            cursor: pointer;
        }

        .day-selector:focus {
            outline: none;
            border-color: var(--accent);
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .back-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Utility Classes */
        .hidden { display: none !important; }
        .text-success { color: var(--success); }
        .text-warning { color: var(--warning); }
        .text-error { color: var(--error); }
        .text-muted { color: var(--text-secondary); }
        .font-mono { font-family: 'SF Mono', Monaco, 'Courier New', monospace; }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--border);
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .header-right {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- ===========================================
         HEADER
         =========================================== -->
    <header class="header">
        <div class="header-left">
            <div class="logo">PPAYA</div>
            <div class="header-title">
                <h1>HH Generation Dashboard</h1>
                <p id="headerSubtitle">Upload generation data to begin</p>
            </div>
        </div>
        <div class="header-right" id="headerStats">
            <!-- Portfolio summary stats will be added here -->
        </div>
    </header>

    <!-- ===========================================
         MAIN CONTAINER
         =========================================== -->
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <!-- Upload Section -->
            <div class="sidebar-section">
                <h3>üìä Add Site</h3>
                <div class="upload-area" id="uploadArea">
                    <div class="icon">üìÅ</div>
                    <div class="text">Click or drag to upload HH data</div>
                    <input type="file" id="fileInput" accept=".xlsx,.xls" multiple>
                </div>
            </div>

            <!-- Sites List -->
            <div class="sidebar-section">
                <h3>‚ö° Loaded Sites (<span id="siteCount">0</span>)</h3>
                <div id="sitesList">
                    <p class="text-muted" style="font-size: 0.875rem;" id="noSitesMsg">No sites loaded yet</p>
                </div>
            </div>

            <!-- Site Configuration (shown when site selected) -->
            <div class="sidebar-section hidden" id="siteConfig">
                <h3>‚öôÔ∏è Site Configuration</h3>
                <div class="form-group">
                    <label>Site Name</label>
                    <input type="text" id="siteNameInput" placeholder="Enter site name">
                </div>
                <div class="form-group">
                    <label>Asset Type</label>
                    <select id="assetTypeSelect">
                        <option value="AD">üåø Anaerobic Digestion</option>
                        <option value="Wind">üí® Wind</option>
                        <option value="Solar">‚òÄÔ∏è Solar</option>
                        <option value="Hydro">üíß Hydro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Capacity (kW)</label>
                    <input type="number" id="capacityInput" placeholder="e.g. 200">
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main">
            <!-- Empty State -->
            <div class="empty-state" id="emptyState">
                <div class="icon">üìä</div>
                <h2>Upload HH Generation Data</h2>
                <p>Upload Excel files with half-hourly generation data. You can upload multiple sites and compare them.</p>
            </div>

            <!-- Dashboard Content (hidden until data loaded) -->
            <div class="hidden" id="dashboard">
                <!-- Portfolio View -->
                <div id="portfolioView">
                    <div class="chart-container">
                        <h3>Portfolio Overview</h3>
                        <div class="data-table-scroll">
                            <table class="portfolio-table">
                                <thead>
                                    <tr>
                                        <th>Site</th>
                                        <th>Type</th>
                                        <th>Capacity</th>
                                        <th>Total MWh</th>
                                        <th>CF %</th>
                                        <th>Availability</th>
                                        <th>Days</th>
                                    </tr>
                                </thead>
                                <tbody id="portfolioTableBody">
                                    <!-- Rows added dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Site Detail View (hidden until site selected) -->
                <div class="hidden" id="siteDetailView">
                    <button class="back-btn" id="backToPortfolio">‚Üê Back to Portfolio</button>

                    <!-- Stats Cards -->
                    <div class="stats-grid" id="statsGrid">
                        <!-- Cards added dynamically -->
                    </div>

                    <!-- View Tabs -->
                    <div class="view-tabs" id="viewTabs">
                        <button class="view-tab" data-view="hourly">Hourly</button>
                        <button class="view-tab" data-view="day">Day</button>
                        <button class="view-tab" data-view="week">Week</button>
                        <button class="view-tab active" data-view="month">Month</button>
                        <button class="view-tab" data-view="year">Year</button>
                    </div>

                    <!-- Hourly View -->
                    <div class="hidden" id="hourlyView">
                        <div class="chart-container">
                            <h3>Select Day</h3>
                            <select class="day-selector" id="daySelector"></select>
                            <div class="stats-grid" id="hourlyStats" style="margin-top: 1rem;"></div>
                            <h3 id="hourlyChartTitle">Half-Hourly Profile</h3>
                            <div class="chart-wrapper">
                                <canvas id="hourlyChart"></canvas>
                            </div>
                        </div>
                        <div class="data-table">
                            <div class="data-table-header">Half-Hourly Data</div>
                            <div class="data-table-scroll">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Period</th>
                                            <th>Time</th>
                                            <th>Generation (kWh)</th>
                                            <th>Utilisation</th>
                                        </tr>
                                    </thead>
                                    <tbody id="hourlyTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Aggregate View (Day/Week/Month/Year) -->
                    <div id="aggregateView">
                        <div class="chart-container">
                            <h3 id="mainChartTitle">Monthly Generation</h3>
                            <div class="chart-wrapper">
                                <canvas id="mainChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-container">
                            <h3>Capacity Factor Trend</h3>
                            <div class="chart-wrapper">
                                <canvas id="cfChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ===========================================
         JAVASCRIPT
         =========================================== -->
    <script>
        /*
         * ===========================================
         * ASSET TYPE CONFIGURATIONS
         * ===========================================
         */
        const ASSET_TYPES = {
            AD: {
                name: 'Anaerobic Digestion',
                color: '#14b8a6',
                expectedCF: [80, 95],
                icon: 'üåø'
            },
            Wind: {
                name: 'Wind',
                color: '#3b82f6',
                expectedCF: [25, 45],
                icon: 'üí®'
            },
            Solar: {
                name: 'Solar',
                color: '#f59e0b',
                expectedCF: [10, 15],
                icon: '‚òÄÔ∏è'
            },
            Hydro: {
                name: 'Hydro',
                color: '#06b6d4',
                expectedCF: [25, 45],
                icon: 'üíß'
            }
        };

        /*
         * ===========================================
         * STATE MANAGEMENT
         * ===========================================
         */
        let sites = [];
        let selectedSiteId = null;
        let currentView = 'month';

        // Chart instances
        let mainChart = null;
        let cfChart = null;
        let hourlyChart = null;

        /*
         * ===========================================
         * EXCEL PARSING
         * ===========================================
         */
        function parseHHData(workbook, filename) {
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const rawData = XLSX.utils.sheet_to_json(sheet);

            const data = rawData.map(row => {
                let date;
                if (row.DATE instanceof Date) {
                    date = row.DATE;
                } else if (typeof row.DATE === 'number') {
                    date = new Date((row.DATE - 25569) * 86400 * 1000);
                } else {
                    date = new Date(row.DATE);
                }

                const hhValues = [];
                for (let i = 1; i <= 48; i++) {
                    hhValues.push(parseFloat(row[`P${i}_HHC`]) || 0);
                }

                const dailyTotal = hhValues.reduce((a, b) => a + b, 0);

                return {
                    date,
                    dateStr: date.toISOString().split('T')[0],
                    mpan: row.MPAN,
                    hhValues,
                    dailyKwh: dailyTotal,
                    dailyMwh: dailyTotal / 1000
                };
            }).filter(d => !isNaN(d.date.getTime()))
              .sort((a, b) => a.date - b.date);

            return {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                filename,
                mpan: data[0]?.mpan || 'Unknown',
                name: filename.replace(/\.[^/.]+$/, ''),
                assetType: 'AD',
                capacityKw: null,
                data
            };
        }

        /*
         * ===========================================
         * CALCULATIONS
         * ===========================================
         */
        function calculateSiteStats(site) {
            if (!site.data || site.data.length === 0) return null;

            const cap = site.capacityKw || 0;
            const totalKwh = site.data.reduce((sum, d) => sum + d.dailyKwh, 0);
            const totalDays = site.data.length;
            const maxPossible = cap * totalDays * 24;
            const cf = cap > 0 ? (totalKwh / maxPossible) * 100 : 0;

            const sortedByOutput = [...site.data].sort((a, b) => b.dailyKwh - a.dailyKwh);
            const bestDay = sortedByOutput[0];
            const worstDay = sortedByOutput[sortedByOutput.length - 1];

            const cutoff = new Date(site.data[site.data.length - 1].date);
            cutoff.setDate(cutoff.getDate() - 365);
            const last12m = site.data.filter(d => d.date >= cutoff);
            const l12mKwh = last12m.reduce((sum, d) => sum + d.dailyKwh, 0);
            const l12mCf = last12m.length > 0 && cap > 0 ? (l12mKwh / (cap * last12m.length * 24)) * 100 : 0;

            const outageDays = site.data.filter(d => d.dailyKwh < 100).length;

            return {
                totalMwh: totalKwh / 1000,
                totalDays,
                capacityFactor: cf,
                bestDay,
                worstDay,
                last12mMwh: l12mKwh / 1000,
                last12mCf: l12mCf,
                avgDailyKwh: totalKwh / totalDays,
                outageDays,
                availability: ((totalDays - outageDays) / totalDays) * 100,
                dateRange: {
                    start: site.data[0].date,
                    end: site.data[site.data.length - 1].date
                }
            };
        }

        function getChartData(site, view) {
            if (!site || !site.data) return [];

            const cap = site.capacityKw || 0;

            if (view === 'day') {
                const last30 = site.data.slice(-30);
                return last30.map(d => ({
                    label: d.date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' }),
                    generation: d.dailyKwh,
                    cf: cap > 0 ? (d.dailyKwh / (cap * 24)) * 100 : 0
                }));
            }

            if (view === 'week') {
                const weeks = {};
                site.data.forEach(d => {
                    const weekStart = new Date(d.date);
                    weekStart.setDate(weekStart.getDate() - weekStart.getDay() + 1);
                    const key = weekStart.toISOString().split('T')[0];
                    if (!weeks[key]) weeks[key] = { days: [], total: 0, weekStart };
                    weeks[key].days.push(d);
                    weeks[key].total += d.dailyKwh;
                });

                return Object.values(weeks).map(w => ({
                    label: `w/c ${w.weekStart.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' })}`,
                    generation: w.total / 1000,
                    cf: cap > 0 ? (w.total / (cap * w.days.length * 24)) * 100 : 0
                }));
            }

            if (view === 'month') {
                const months = {};
                site.data.forEach(d => {
                    const key = `${d.date.getFullYear()}-${String(d.date.getMonth() + 1).padStart(2, '0')}`;
                    if (!months[key]) months[key] = { days: [], total: 0, month: d.date };
                    months[key].days.push(d);
                    months[key].total += d.dailyKwh;
                });

                return Object.values(months).map(m => ({
                    label: m.month.toLocaleDateString('en-GB', { month: 'short', year: '2-digit' }),
                    generation: m.total / 1000,
                    cf: cap > 0 ? (m.total / (cap * m.days.length * 24)) * 100 : 0
                }));
            }

            if (view === 'year') {
                const years = {};
                site.data.forEach(d => {
                    const key = d.date.getFullYear();
                    if (!years[key]) years[key] = { days: [], total: 0, year: key };
                    years[key].days.push(d);
                    years[key].total += d.dailyKwh;
                });

                return Object.values(years).map(y => ({
                    label: y.year.toString(),
                    generation: y.total / 1000,
                    cf: cap > 0 ? (y.total / (cap * y.days.length * 24)) * 100 : 0
                }));
            }

            return [];
        }

        function getHourlyData(site, dateStr) {
            if (!site || !site.data) return [];

            const dayData = site.data.find(d => d.dateStr === dateStr);
            if (!dayData) return [];

            const cap = site.capacityKw || 0;
            const maxHH = cap * 0.5;

            return dayData.hhValues.map((val, i) => {
                const hour = Math.floor(i / 2);
                const min = i % 2 === 0 ? '00' : '30';
                return {
                    period: i + 1,
                    time: `${hour.toString().padStart(2, '0')}:${min}`,
                    generation: val,
                    maxCapacity: maxHH,
                    utilisation: maxHH > 0 ? (val / maxHH) * 100 : 0
                };
            });
        }

        /*
         * ===========================================
         * UI UPDATES
         * ===========================================
         */
        function updateUI() {
            document.getElementById('siteCount').textContent = sites.length;
            document.getElementById('headerSubtitle').textContent =
                sites.length > 0
                    ? `${sites.length} site${sites.length > 1 ? 's' : ''} loaded`
                    : 'Upload generation data to begin';

            // Update header stats
            if (sites.length > 0) {
                const totalMwh = sites.reduce((sum, site) => {
                    const stats = calculateSiteStats(site);
                    return sum + (stats ? stats.totalMwh : 0);
                }, 0);

                const totalCapacity = sites.reduce((sum, site) => sum + (site.capacityKw || 0), 0);

                document.getElementById('headerStats').innerHTML = `
                    <div class="header-stat">
                        <div class="label">Total Capacity</div>
                        <div class="value">${formatNumber(totalCapacity, 0)} kW</div>
                    </div>
                    <div class="header-stat">
                        <div class="label">Total Generation</div>
                        <div class="value">${formatNumber(totalMwh, 1)} MWh</div>
                    </div>
                `;
            } else {
                document.getElementById('headerStats').innerHTML = '';
            }

            document.getElementById('emptyState').classList.toggle('hidden', sites.length > 0);
            document.getElementById('dashboard').classList.toggle('hidden', sites.length === 0);

            updateSitesList();
            updatePortfolioTable();

            if (selectedSiteId) {
                updateSiteDetailView();
            }
        }

        function updateSitesList() {
            const container = document.getElementById('sitesList');
            const noSitesMsg = document.getElementById('noSitesMsg');

            if (sites.length === 0) {
                noSitesMsg.classList.remove('hidden');
                container.innerHTML = '';
                container.appendChild(noSitesMsg);
                return;
            }

            noSitesMsg.classList.add('hidden');
            container.innerHTML = sites.map(site => {
                const stats = calculateSiteStats(site);
                const config = ASSET_TYPES[site.assetType];
                return `
                    <div class="site-item ${site.id === selectedSiteId ? 'active' : ''}"
                         onclick="selectSite('${site.id}')"
                         data-site-id="${site.id}">
                        <div class="info">
                            <div class="name">${config.icon} ${site.name}</div>
                            <div class="meta">${stats ? formatNumber(stats.totalMwh, 1) + ' MWh ‚Ä¢ ' + site.data.length + ' days' : 'Configure capacity'}</div>
                        </div>
                        <button class="remove-btn" onclick="event.stopPropagation(); removeSite('${site.id}')">‚úï</button>
                    </div>
                `;
            }).join('');
        }

        function updatePortfolioTable() {
            const tbody = document.getElementById('portfolioTableBody');

            tbody.innerHTML = sites.map(site => {
                const stats = calculateSiteStats(site);
                const config = ASSET_TYPES[site.assetType];
                const cfColor = stats && site.capacityKw && stats.capacityFactor >= config.expectedCF[0]
                    ? 'text-success' : 'text-error';

                return `
                    <tr onclick="selectSite('${site.id}')">
                        <td><strong>${config.icon} ${site.name}</strong></td>
                        <td>${config.name}</td>
                        <td>${site.capacityKw ? site.capacityKw + ' kW' : '-'}</td>
                        <td>${stats ? formatNumber(stats.totalMwh, 1) : '-'}</td>
                        <td class="${cfColor}">${stats && site.capacityKw ? formatNumber(stats.capacityFactor, 1) + '%' : '-'}</td>
                        <td>${stats ? formatNumber(stats.availability, 1) + '%' : '-'}</td>
                        <td>${site.data.length}</td>
                    </tr>
                `;
            }).join('');
        }

        function selectSite(siteId) {
            selectedSiteId = siteId;

            document.querySelectorAll('.site-item').forEach(item => {
                item.classList.toggle('active', item.dataset.siteId === siteId);
            });

            document.getElementById('siteConfig').classList.remove('hidden');
            document.getElementById('portfolioView').classList.add('hidden');
            document.getElementById('siteDetailView').classList.remove('hidden');

            const site = sites.find(s => s.id === siteId);
            if (site) {
                document.getElementById('siteNameInput').value = site.name;
                document.getElementById('assetTypeSelect').value = site.assetType;
                document.getElementById('capacityInput').value = site.capacityKw || '';

                populateDaySelector(site);
            }

            updateSiteDetailView();
        }

        function populateDaySelector(site) {
            if (!site || !site.data) return;

            const selector = document.getElementById('daySelector');
            selector.innerHTML = '';
            const reversed = [...site.data].reverse();
            reversed.forEach(day => {
                const option = document.createElement('option');
                option.value = day.dateStr;
                option.textContent = `${day.date.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' })} ‚Äî ${formatNumber(day.dailyKwh, 0)} kWh`;
                selector.appendChild(option);
            });
        }

        function updateSiteDetailView() {
            const site = sites.find(s => s.id === selectedSiteId);
            if (!site) return;

            const stats = calculateSiteStats(site);
            const config = ASSET_TYPES[site.assetType];

            const cfColor = site.capacityKw && stats.capacityFactor >= config.expectedCF[0] ? 'var(--success)' : 'var(--error)';
            const availColor = stats.availability >= 95 ? 'var(--success)' : 'var(--warning)';

            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card">
                    <div class="label">Total Generation</div>
                    <div class="value">${formatNumber(stats.totalMwh, 1)} MWh</div>
                    <div class="subtitle">${stats.totalDays} days</div>
                </div>
                <div class="stat-card">
                    <div class="label">Capacity Factor</div>
                    <div class="value" style="color: ${site.capacityKw ? cfColor : 'var(--text-primary)'}">${site.capacityKw ? formatNumber(stats.capacityFactor, 1) + '%' : 'Set capacity'}</div>
                    <div class="subtitle">Target: ${config.expectedCF[0]}-${config.expectedCF[1]}%</div>
                </div>
                <div class="stat-card">
                    <div class="label">Last 12 Months</div>
                    <div class="value">${formatNumber(stats.last12mMwh, 1)} MWh</div>
                    <div class="subtitle">CF: ${site.capacityKw ? formatNumber(stats.last12mCf, 1) + '%' : '-'}</div>
                </div>
                <div class="stat-card">
                    <div class="label">Daily Average</div>
                    <div class="value">${formatNumber(stats.avgDailyKwh, 0)} kWh</div>
                    <div class="subtitle">Best: ${formatNumber(stats.bestDay.dailyKwh, 0)} kWh</div>
                </div>
                <div class="stat-card">
                    <div class="label">Availability</div>
                    <div class="value" style="color: ${availColor}">${formatNumber(stats.availability, 1)}%</div>
                    <div class="subtitle">${stats.outageDays} outage days</div>
                </div>
            `;

            updateCharts();
        }

        function removeSite(siteId) {
            sites = sites.filter(s => s.id !== siteId);
            if (selectedSiteId === siteId) {
                selectedSiteId = null;
                document.getElementById('siteConfig').classList.add('hidden');
                document.getElementById('siteDetailView').classList.add('hidden');
                document.getElementById('portfolioView').classList.remove('hidden');
            }
            updateUI();
        }

        function backToPortfolio() {
            selectedSiteId = null;
            document.querySelectorAll('.site-item').forEach(item => {
                item.classList.remove('active');
            });
            document.getElementById('siteConfig').classList.add('hidden');
            document.getElementById('siteDetailView').classList.add('hidden');
            document.getElementById('portfolioView').classList.remove('hidden');
        }

        /*
         * ===========================================
         * CHART RENDERING
         * ===========================================
         */
        function updateCharts() {
            const site = sites.find(s => s.id === selectedSiteId);
            if (!site) return;

            const config = ASSET_TYPES[site.assetType];

            if (currentView === 'hourly') {
                document.getElementById('hourlyView').classList.remove('hidden');
                document.getElementById('aggregateView').classList.add('hidden');
                updateHourlyView();
            } else {
                document.getElementById('hourlyView').classList.add('hidden');
                document.getElementById('aggregateView').classList.remove('hidden');

                const chartData = getChartData(site, currentView);
                const labels = chartData.map(d => d.label);
                const genData = chartData.map(d => d.generation);
                const cfData = chartData.map(d => d.cf);

                const titles = {
                    day: 'Daily Generation (Last 30 Days) ‚Äî kWh',
                    week: 'Weekly Generation ‚Äî MWh',
                    month: 'Monthly Generation ‚Äî MWh',
                    year: 'Yearly Generation ‚Äî MWh'
                };
                document.getElementById('mainChartTitle').textContent = titles[currentView];

                if (mainChart) mainChart.destroy();
                mainChart = new Chart(document.getElementById('mainChart'), {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [{
                            label: currentView === 'day' ? 'Generation (kWh)' : 'Generation (MWh)',
                            data: genData,
                            backgroundColor: config.color,
                            borderRadius: 4,
                            yAxisID: 'y'
                        }, {
                            label: 'Capacity Factor (%)',
                            data: cfData,
                            type: 'line',
                            borderColor: '#f59e0b',
                            backgroundColor: 'transparent',
                            tension: 0.3,
                            pointRadius: 3,
                            pointBackgroundColor: '#f59e0b',
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { labels: { color: '#94a3b8' } }
                        },
                        scales: {
                            x: { ticks: { color: '#94a3b8' }, grid: { color: '#1e3a5f' } },
                            y: {
                                ticks: { color: '#94a3b8' },
                                grid: { color: '#1e3a5f' },
                                title: { display: true, text: currentView === 'day' ? 'kWh' : 'MWh', color: '#94a3b8' }
                            },
                            y1: {
                                position: 'right',
                                ticks: { color: '#f59e0b' },
                                grid: { display: false },
                                min: 0,
                                max: 100,
                                title: { display: true, text: 'CF %', color: '#f59e0b' }
                            }
                        }
                    }
                });

                if (cfChart) cfChart.destroy();
                cfChart = new Chart(document.getElementById('cfChart'), {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Capacity Factor (%)',
                            data: cfData,
                            borderColor: config.color,
                            backgroundColor: config.color + '40',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { color: '#94a3b8' } }
                        },
                        scales: {
                            x: { ticks: { color: '#94a3b8' }, grid: { color: '#1e3a5f' } },
                            y: {
                                ticks: { color: '#94a3b8' },
                                grid: { color: '#1e3a5f' },
                                min: 0,
                                max: 100
                            }
                        }
                    }
                });
            }
        }

        function updateHourlyView() {
            const site = sites.find(s => s.id === selectedSiteId);
            if (!site) return;

            const selectedDate = document.getElementById('daySelector').value;
            if (!selectedDate) return;

            const config = ASSET_TYPES[site.assetType];
            const hourlyData = getHourlyData(site, selectedDate);

            const genValues = hourlyData.map(h => h.generation);
            const total = genValues.reduce((a, b) => a + b, 0);
            const max = Math.max(...genValues);
            const min = Math.min(...genValues.filter(v => v > 0)) || 0;
            const avg = total / 48;
            const cf = site.capacityKw > 0 ? (total / (site.capacityKw * 24)) * 100 : 0;

            const cfColor = site.capacityKw && cf >= config.expectedCF[0] ? 'var(--success)' : 'var(--error)';

            document.getElementById('hourlyStats').innerHTML = `
                <div class="stat-card" style="padding: 0.75rem;">
                    <div class="label">Day Total</div>
                    <div class="value" style="font-size: 1.25rem;">${formatNumber(total, 0)} kWh</div>
                </div>
                <div class="stat-card" style="padding: 0.75rem;">
                    <div class="label">Capacity Factor</div>
                    <div class="value" style="font-size: 1.25rem; color: ${site.capacityKw ? cfColor : 'var(--text-primary)'}">${site.capacityKw ? formatNumber(cf, 1) + '%' : '-'}</div>
                </div>
                <div class="stat-card" style="padding: 0.75rem;">
                    <div class="label">Peak HH</div>
                    <div class="value" style="font-size: 1.25rem; color: var(--success);">${formatNumber(max, 1)} kWh</div>
                </div>
                <div class="stat-card" style="padding: 0.75rem;">
                    <div class="label">Min HH</div>
                    <div class="value" style="font-size: 1.25rem; color: var(--error);">${formatNumber(min, 1)} kWh</div>
                </div>
                <div class="stat-card" style="padding: 0.75rem;">
                    <div class="label">Average HH</div>
                    <div class="value" style="font-size: 1.25rem;">${formatNumber(avg, 1)} kWh</div>
                </div>
            `;

            const dayData = site.data.find(d => d.dateStr === selectedDate);
            document.getElementById('hourlyChartTitle').textContent = `Half-Hourly Profile ‚Äî ${dayData.date.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}`;

            const labels = hourlyData.map(h => h.time);
            const genDataPoints = hourlyData.map(h => h.generation);
            const maxCapData = hourlyData.map(h => h.maxCapacity);

            if (hourlyChart) hourlyChart.destroy();
            hourlyChart = new Chart(document.getElementById('hourlyChart'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Max Capacity (kWh)',
                            data: maxCapData,
                            backgroundColor: '#1e3a5f',
                            borderRadius: 4,
                            order: 2
                        },
                        {
                            label: 'Generation (kWh)',
                            data: genDataPoints,
                            backgroundColor: config.color,
                            borderRadius: 4,
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#94a3b8' } }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8', maxRotation: 45, minRotation: 45 },
                            grid: { color: '#1e3a5f' }
                        },
                        y: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#1e3a5f' }
                        }
                    }
                }
            });

            const tableBody = document.getElementById('hourlyTableBody');
            tableBody.innerHTML = hourlyData.map(h => `
                <tr>
                    <td style="color: #94a3b8;">${h.period}</td>
                    <td style="font-family: monospace;">${h.time}</td>
                    <td style="color: ${config.color}; font-family: monospace;">${formatNumber(h.generation, 1)}</td>
                    <td>
                        <div class="utilisation-bar">
                            <div class="utilisation-fill" style="width: ${Math.min(h.utilisation, 100)}%; background: ${config.color};"></div>
                        </div>
                        <span style="color: #94a3b8; font-size: 0.75rem;">${formatNumber(h.utilisation, 0)}%</span>
                    </td>
                </tr>
            `).join('');
        }

        /*
         * ===========================================
         * UTILITY FUNCTIONS
         * ===========================================
         */
        function formatNumber(num, decimals = 0) {
            if (num === null || num === undefined || isNaN(num)) return '-';
            return num.toLocaleString(undefined, {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        }

        /*
         * ===========================================
         * EVENT LISTENERS
         * ===========================================
         */

        document.getElementById('uploadArea').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const workbook = XLSX.read(evt.target.result, { type: 'binary', cellDates: true });
                        const site = parseHHData(workbook, file.name);
                        sites.push(site);
                        updateUI();
                    } catch (err) {
                        alert('Error parsing file: ' + err.message);
                    }
                };
                reader.readAsBinaryString(file);
            });
            e.target.value = '';
        });

        document.getElementById('siteNameInput').addEventListener('input', (e) => {
            const site = sites.find(s => s.id === selectedSiteId);
            if (site) {
                site.name = e.target.value;
                updateUI();
            }
        });

        document.getElementById('assetTypeSelect').addEventListener('change', (e) => {
            const site = sites.find(s => s.id === selectedSiteId);
            if (site) {
                site.assetType = e.target.value;
                updateUI();
            }
        });

        document.getElementById('capacityInput').addEventListener('input', (e) => {
            const site = sites.find(s => s.id === selectedSiteId);
            if (site) {
                site.capacityKw = parseFloat(e.target.value) || null;
                updateUI();
            }
        });

        document.getElementById('viewTabs').addEventListener('click', (e) => {
            if (e.target.classList.contains('view-tab')) {
                document.querySelectorAll('.view-tab').forEach(t => t.classList.remove('active'));
                e.target.classList.add('active');
                currentView = e.target.dataset.view;

                document.getElementById('hourlyView').classList.toggle('hidden', currentView !== 'hourly');
                document.getElementById('aggregateView').classList.toggle('hidden', currentView === 'hourly');

                updateCharts();
            }
        });

        document.getElementById('daySelector').addEventListener('change', updateHourlyView);

        document.getElementById('backToPortfolio').addEventListener('click', backToPortfolio);

        // Drag and drop
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = 'var(--accent)';
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = 'var(--border)';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = 'var(--border)';

            const files = Array.from(e.dataTransfer.files);
            files.forEach(file => {
                if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        try {
                            const workbook = XLSX.read(evt.target.result, { type: 'binary', cellDates: true });
                            const site = parseHHData(workbook, file.name);
                            sites.push(site);
                            updateUI();
                        } catch (err) {
                            alert('Error parsing file: ' + err.message);
                        }
                    };
                    reader.readAsBinaryString(file);
                }
            });
        });

        // Initial render
        updateUI();
    </script>
</body>
</html>
